generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Proxy {
  deviceId          String   @id @map("device_id") @db.VarChar(255)
  name             String
  model            String?   @db.VarChar(255)
  location         String?
  country          String?   @db.VarChar(100)
  state            String?   @db.VarChar(100)
  city             String?   @db.VarChar(100)
  street           String?   @db.VarChar(255)
  latitude         Float?
  longitude        Float?
  host             String
  port             Int
  protocol         String   @default("http")
  username         String?
  password         String?
  active           Boolean  @default(true)
  deviceIp         String?  @map("device_ip") @db.VarChar(45)
  wsStatus         String?  @map("ws_status") @db.VarChar(50)
  relayServerId    Int?     @map("relay_server_id")
  downloadNetSpeed Float?   @map("download_net_speed")
  uploadNetSpeed   Float?   @map("upload_net_speed")
  lastIpRotation   DateTime? @map("last_ip_rotation")
  apiCreatedAt     DateTime? @map("api_created_at")
  apiUpdatedAt     DateTime? @map("api_updated_at")
  lastOutboundIp   String?  @map("last_outbound_ip") @db.VarChar(45)
  sameIpCount      Int      @default(0) @map("same_ip_count")
  stabilityStatus  String   @default("Unknown") @map("stability_status")
  rotationStatus   String?  @default("Unknown") @map("rotation_status")
  lastRotationAt   DateTime? @map("last_rotation_at")
  rotationCount     Int      @default(0) @map("rotation_count")
  lastManualRotationAt DateTime? @map("last_manual_rotation_at")
  manualRotationCount Int @default(0) @map("manual_rotation_count")
  isManualRotation Boolean @default(false) @map("is_manual_rotation")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  requests         ProxyRequest[]

  @@index([active])
  @@index([stabilityStatus])
  @@index([rotationStatus])
  @@index([updatedAt])
  @@index([country])
  @@index([state])
  @@index([city])
  @@index([lastManualRotationAt])
  @@index([isManualRotation])
  @@map("proxies")
}

model ProxyRequest {
  id              String   @id @default(uuid())
  proxyId         String   @map("proxy_id") @db.VarChar(255)
  timestamp       DateTime @default(now())
  targetUrl       String   @map("target_url")
  status          String
  httpStatusCode  Int?     @map("http_status_code")
  responseTimeMs  Int?     @map("response_time_ms")
  expectedIp      String?  @map("expected_ip")
  outboundIp      String?  @map("outbound_ip")
  ipChanged       Boolean  @default(false) @map("ip_changed")
  errorType       String?  @map("error_type")
  errorMessage    String?  @map("error_message")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  proxy           Proxy    @relation(fields: [proxyId], references: [deviceId], onDelete: Cascade)

  @@index([proxyId, timestamp])
  @@index([timestamp])
  @@index([status])
  @@index([outboundIp])
  @@index([expectedIp])
  @@index([ipChanged])
  @@index([createdAt])
  @@index([updatedAt])
  @@map("proxy_requests")
}

