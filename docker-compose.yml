services:
  mysql:
    image: mysql:9.0
    container_name: x-proxy-tester-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-xproxy_tester}
      MYSQL_USER: ${MYSQL_USER:-xproxy}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-xproxy}
    ports:
      - "3310:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init-grafana-views.sh:/docker-entrypoint-initdb.d/init-grafana-views.sh:ro
      - ./mysql-docker-config.cnf:/etc/mysql/conf.d/custom.cnf:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 60s
    networks:
      - proxy-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: x-proxy-tester-app
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: mysql://${MYSQL_USER:-xproxy}:${MYSQL_PASSWORD:-xproxy}@mysql:3306/${MYSQL_DATABASE:-xproxy_tester}
      
      # XProxy API
      XPROXY_API_URL: ${XPROXY_API_URL:-https://jmui.vercel.app}
      XPROXY_API_ENDPOINT: ${XPROXY_API_ENDPOINT:-/api/phones}
      XPROXY_API_TOKEN: ${XPROXY_API_TOKEN}
      XPROXY_API_TIMEOUT_MS: ${XPROXY_API_TIMEOUT_MS:-30000}
      
      # Testing
      TEST_TARGET_URL: ${TEST_TARGET_URL:-https://api.ipify.org?format=json}
      TEST_INTERVAL_MS: ${TEST_INTERVAL_MS:-5000}
      REQUEST_TIMEOUT_MS: ${REQUEST_TIMEOUT_MS:-30000}
      ROTATION_THRESHOLD: ${ROTATION_THRESHOLD:-10}
      
      # Refresh
      PROXY_REFRESH_INTERVAL_MS: ${PROXY_REFRESH_INTERVAL_MS:-21600000}
      
      # Stability
      STABILITY_CHECK_INTERVAL_MS: ${STABILITY_CHECK_INTERVAL_MS:-1200000}
      
      # Auto-Deactivation
      AUTO_DEACTIVATION_ENABLED: ${AUTO_DEACTIVATION_ENABLED:-true}
      AUTO_DEACTIVATION_CONSECUTIVE_FAILURES: ${AUTO_DEACTIVATION_CONSECUTIVE_FAILURES:-20}
      AUTO_DEACTIVATION_FAILURE_RATE: ${AUTO_DEACTIVATION_FAILURE_RATE:-0.9}
      AUTO_DEACTIVATION_FAILURE_RATE_WINDOW: ${AUTO_DEACTIVATION_FAILURE_RATE_WINDOW:-50}
      
      # Auto-Recovery
      AUTO_RECOVERY_ENABLED: ${AUTO_RECOVERY_ENABLED:-true}
      AUTO_RECOVERY_CHECK_INTERVAL_MS: ${AUTO_RECOVERY_CHECK_INTERVAL_MS:-600000}
      AUTO_RECOVERY_CONSECUTIVE_SUCCESSES: ${AUTO_RECOVERY_CONSECUTIVE_SUCCESSES:-5}
      
      # IP Rotation
      IP_ROTATION_ENABLED: ${IP_ROTATION_ENABLED:-true}
      IP_ROTATION_CHECK_INTERVAL_MS: ${IP_ROTATION_CHECK_INTERVAL_MS:-120000}
      IP_ROTATION_WAIT_AFTER_ROTATION_MS: ${IP_ROTATION_WAIT_AFTER_ROTATION_MS:-5000}
      IP_ROTATION_COOLDOWN_MS: ${IP_ROTATION_COOLDOWN_MS:-300000}
      IP_ROTATION_PREFER_UNIQUE: ${IP_ROTATION_PREFER_UNIQUE:-false}
      PERIODIC_IP_ROTATION_INTERVAL_MS: ${PERIODIC_IP_ROTATION_INTERVAL_MS:-600000}
      
      # IP Rotation Testing
      IP_ROTATION_TESTING_ENABLED: ${IP_ROTATION_TESTING_ENABLED:-true}
      IP_ROTATION_TESTING_INTERVAL_MS: ${IP_ROTATION_TESTING_INTERVAL_MS:-900000}
      IP_ROTATION_TESTING_WAIT_AFTER_ROTATION_MS: ${IP_ROTATION_TESTING_WAIT_AFTER_ROTATION_MS:-10000}
      IP_ROTATION_TESTING_CONCURRENCY: ${IP_ROTATION_TESTING_CONCURRENCY:-10}
      IP_ROTATION_TESTING_BATCH_SIZE: ${IP_ROTATION_TESTING_BATCH_SIZE:-50}
      
      # Runtime
      MIN_RUN_HOURS: ${MIN_RUN_HOURS:-72}
      RUN_MODE: ${RUN_MODE:-infinite}
      MONITOR_CHECK_INTERVAL_MS: ${MONITOR_CHECK_INTERVAL_MS:-3600000}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Encryption
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      ENCRYPTION_SALT: ${ENCRYPTION_SALT}
      
      # Health Check
      HEALTH_CHECK_PORT: ${HEALTH_CHECK_PORT:-3000}
      
      # Archival
      ENABLE_ARCHIVAL: ${ENABLE_ARCHIVAL:-true}
      DATA_RETENTION_DAYS: ${DATA_RETENTION_DAYS:-30}
      ARCHIVAL_INTERVAL_MS: ${ARCHIVAL_INTERVAL_MS:-86400000}
      ARCHIVAL_BATCH_SIZE: ${ARCHIVAL_BATCH_SIZE:-1000}
      
      # Alert Monitoring
      ENABLE_ALERT_MONITORING: ${ENABLE_ALERT_MONITORING:-true}
      ALERT_CHECK_INTERVAL_MS: ${ALERT_CHECK_INTERVAL_MS:-120000}
      ALERT_WEBHOOK_URL: ${ALERT_WEBHOOK_URL:-}
      SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
    ports:
      - "3311:3000"
    volumes:
      - ./logs:/app/logs
    networks:
      - proxy-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s

  grafana:
    image: grafana/grafana:latest
    container_name: x-proxy-tester-grafana
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      app:
        condition: service_healthy
    ports:
      - "3312:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=
      - GF_SERVER_ROOT_URL=http://localhost:3312
      - GF_SERVER_HTTP_PORT=3000
      # Performance and stability settings
      - GF_ALERTING_EVALUATION_TIMEOUT_SECONDS=60
      - GF_ALERTING_MAX_ATTEMPTS=3
      - GF_ALERTING_MIN_INTERVAL_SECONDS=30
      - GF_DATABASE_MAX_IDLE_CONN=25
      - GF_DATABASE_MAX_OPEN_CONN=100
      - GF_DATABASE_CONN_MAX_LIFETIME_SECONDS=14400
      - GF_SERVER_ENABLE_GZIP=true
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_LOG_LEVEL=${GRAFANA_LOG_LEVEL:-warn}
      - GF_LOG_FILTERS=alerting.scheduler:debug
      # Performance optimizations for faster loading
      - GF_DATASOURCES_ALLOW_EDIT=true
      - GF_DATASOURCES_CACHE_TTL=300
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      # Query and rendering performance
      - GF_RENDERING_SERVER_URL=
      - GF_RENDERING_CALLBACK_URL=
      - GF_RENDERING_CONCURRENT_REQUEST_LIMIT=30
      - GF_RENDERING_TIMEOUT=30
      # HTTP and connection settings
      - GF_SERVER_ENFORCE_DOMAIN=false
      - GF_SERVER_SOCKET_TIMEOUT=0
      - GF_SERVER_DOMAIN=localhost
      # Caching settings
      - GF_DATASOURCE_CACHE_TTL=300
      - GF_DASHBOARD_CACHE_TTL=300
      # Session and security settings
      - GF_SECURITY_COOKIE_SECURE=false
      - GF_SECURITY_COOKIE_SAMESITE=lax
      - GF_SECURITY_TOKEN_ROTATION_INTERVAL_MINUTES=10
      - GF_SECURITY_DISABLE_GRAVATAR=true
      # Memory and performance tuning
      - GF_FEATURE_TOGGLES_ENABLE=queryHistory
      - GF_QUERY_HISTORY_ENABLED=true
      - GF_QUERY_HISTORY_TTL_DAYS=7
      # Use SQLite for Grafana's internal database (default, simpler, no connection issues)
      # MySQL is still used as a datasource for querying proxy data via provisioning
      # Commenting out MySQL config to use SQLite default
      # - GF_DATABASE_TYPE=mysql
      # - GF_DATABASE_HOST=mysql:3306
      # - GF_DATABASE_NAME=${MYSQL_DATABASE:-xproxy_tester}
      # - GF_DATABASE_USER=${MYSQL_USER:-xproxy}
      # - GF_DATABASE_PASSWORD=${MYSQL_PASSWORD:-xproxy}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    networks:
      - proxy-network
    # Resource limits optimized for 8GB RAM / 4 vCPU server
    # Note: deploy.resources only works in Docker Swarm mode
    # For standalone docker-compose, set limits manually:
    # docker update --memory=4g --memory-reservation=1g --cpus=3.0 x-proxy-tester-grafana
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  mysql_data:
    driver: local
  grafana_data:
    driver: local

networks:
  proxy-network:
    driver: bridge

